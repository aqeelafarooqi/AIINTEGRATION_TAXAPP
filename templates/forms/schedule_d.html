{% extends "base.html" %}
{% load static custom_filters %}
{% block title %}Schedule D - {{ form.name }}{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/irs_form_common.css' %}">
<style>
  {% inline_static 'css/schedule_d.css' %}
</style>
{% endblock extra_head %}

{% block header %}
  {% if request.user.is_superuser %}
    As superuser you can <a href="{% url "edit_form_fields" form.id %}"> <i class="fa fa-edit"></i> edit master form</a>
  {% endif %}
{% endblock header %}

{% block content %}
{% form_fields_map form as fields %}
{% with taxpayer_obj=taxpayer|default:user %}
{% if taxpayer %}
  <form name="form" action="{% url 'render_form' year=year pk=form.id %}" method="post" data-api-action="{% if taxpayer %}/api/v1/taxpayer/{{ taxpayer.id }}/render/form/{{ year }}/{{ form.id }}/{% else %}/api/v1/taxpayer/self/render/form/{{ year }}/{{ form.id }}/{% endif %}">
{% else %}
  <form name="form" action="{% url 'render_form' year=year pk=form.id %}" method="post" data-api-action="{% if taxpayer %}/api/v1/taxpayer/{{ taxpayer.id }}/render/form/{{ year }}/{{ form.id }}/{% else %}/api/v1/taxpayer/self/render/form/{{ year }}/{{ form.id }}/{% endif %}">
{% endif %}
{% csrf_token %}

{% with spouse=taxpayer.taxpayer_spouse|default_if_none:user.user_spouse %}

<div class="schedule-d-container">
  <div class="schedule-d-top-header">
    <div class="schedule-d-top-left">
      <div class="schedule-d-form-label">SCHEDULE D</div>
      <div class="schedule-d-form-number">(Form 1040)</div>
      <div class="schedule-d-dept-small">Department of the Treasury<br>Internal Revenue Service</div>
    </div>
    <div class="schedule-d-top-center">
      <div class="schedule-d-main-title">Capital Gains and Losses</div>
      <div class="schedule-d-attach-note"><strong>▶ Attach to Form 1040, 1040-SR, or 1040-NR.</strong></div>
      <div class="schedule-d-web-link"><strong>▶ Go to <a href="https://www.irs.gov/ScheduleD" target="_blank">www.irs.gov/ScheduleD</a> for instructions and the latest information.</strong></div>
      <div class="schedule-d-web-link"><strong>▶ Use Form 8949 to list your transactions for lines 1b, 2, 3, 8b, 9, and 10.</strong></div>
    </div>
    <div class="schedule-d-top-right">
      <div class="schedule-d-omb-line">OMB No. 1545-0074</div>
      <div class="schedule-d-year-large">{{ year }}</div>
      <div class="schedule-d-attachment">Attachment<br>Sequence No. <strong>12</strong></div>
    </div>
  </div>

  <div class="schedule-d-name-row">
    <div class="schedule-d-name-label">
      <strong>Name(s) shown on return</strong><br>
      <span style="color: #0033CC; font-weight: bold;">
        {{ taxpayer_obj.first_name|default:'' }} {{ taxpayer_obj.last_name|default:'' }}
        {% if spouse %}
          and {{ spouse.first_name|default:'' }} {{ spouse.last_name|default:'' }}
        {% endif %}
      </span>
    </div>
    <div class="schedule-d-ssn-box">
      <strong>Your social security number</strong><br>
      <span style="color: #0033CC;">{{ taxpayer_obj.ssn|default:'' }}</span>
    </div>
  </div>

  <div class="schedule-d-part-header">
    <strong>Part I &nbsp;&nbsp; Short-Term Capital Gains and Losses—Generally Assets Held One Year or Less</strong>
  </div>
  <div class="schedule-d-note">See instructions for how to figure the amounts to enter on the lines below.</div>
  <div class="schedule-d-note">This form may be easier to complete if you round off cents to whole dollars.</div>

  <table class="schedule-d-table">
    <thead>
      <tr>
        <th class="col-line">Line</th>
        <th class="col-desc">Description</th>
        <th class="col-amount">(d) Proceeds<br>(sales price)</th>
        <th class="col-amount">(e) Cost<br>(or other basis)</th>
        <th class="col-amount">(g) Adjustments<br>to gain or loss</th>
        <th class="col-amount">(h) Gain or (loss)<br>Subtract (e) from (d) and combine with (g)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="col-line">1a</td>
        <td class="col-desc">Totals for all short-term transactions reported on Form 1099-B for which basis was reported to the IRS and for which you have no adjustments</td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'1a_d'|field_id }}" value="{{ fields|get_item:'1a_d'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'1a_e'|field_id }}" value="{{ fields|get_item:'1a_e'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'1a_g'|field_id }}" value="{{ fields|get_item:'1a_g'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'1a_h'|field_id }}" value="{{ fields|get_item:'1a_h'|field_value|default:'' }}" readonly></td>
      </tr>
      <tr>
        <td class="col-line">1b</td>
        <td class="col-desc">Totals for all transactions reported on Form(s) 8949 with Box A checked</td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'1b_d'|field_id }}" value="{{ fields|get_item:'1b_d'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'1b_e'|field_id }}" value="{{ fields|get_item:'1b_e'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'1b_g'|field_id }}" value="{{ fields|get_item:'1b_g'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'1b_h'|field_id }}" value="{{ fields|get_item:'1b_h'|field_value|default:'' }}" readonly></td>
      </tr>
      <tr>
        <td class="col-line">2</td>
        <td class="col-desc">Totals for all transactions reported on Form(s) 8949 with Box B checked</td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'2_d'|field_id }}" value="{{ fields|get_item:'2_d'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'2_e'|field_id }}" value="{{ fields|get_item:'2_e'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'2_g'|field_id }}" value="{{ fields|get_item:'2_g'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'2_h'|field_id }}" value="{{ fields|get_item:'2_h'|field_value|default:'' }}" readonly></td>
      </tr>
      <tr>
        <td class="col-line">3</td>
        <td class="col-desc">Totals for all transactions reported on Form(s) 8949 with Box C checked</td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'3_d'|field_id }}" value="{{ fields|get_item:'3_d'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'3_e'|field_id }}" value="{{ fields|get_item:'3_e'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'3_g'|field_id }}" value="{{ fields|get_item:'3_g'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'3_h'|field_id }}" value="{{ fields|get_item:'3_h'|field_value|default:'' }}" readonly></td>
      </tr>
    </tbody>
  </table>

  <div class="schedule-d-single-lines">
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">4</span>
      <span class="schedule-d-line-text">Short-term gain from Form 6252 and short-term gain or (loss) from Forms 4684, 6781, and 8824</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'4'|field_id }}" value="{{ fields|get_item:'4'|field_value|default:'' }}">
    </div>
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">5</span>
      <span class="schedule-d-line-text">Net short-term gain or (loss) from partnerships, S corporations, estates, and trusts from Schedule(s) K-1</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'5'|field_id }}" value="{{ fields|get_item:'5'|field_value|default:'' }}">
    </div>
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">6</span>
      <span class="schedule-d-line-text">Short-term capital loss carryover. Enter the amount, if any, from line 8 of your Capital Loss Carryover Worksheet</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'6'|field_id }}" value="{{ fields|get_item:'6'|field_value|default:'' }}" style="color: red;">
    </div>
    <div class="schedule-d-form-line schedule-d-total-line">
      <span class="schedule-d-line-num">7</span>
      <span class="schedule-d-line-text"><strong>Net short-term capital gain or (loss).</strong> Combine lines 1a through 6 in column (h)</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'7'|field_id }}" value="{{ fields|get_item:'7'|field_value|default:'' }}" readonly>
    </div>
  </div>

  <div class="schedule-d-part-header">
    <strong>Part II &nbsp;&nbsp; Long-Term Capital Gains and Losses—Generally Assets Held More Than One Year</strong>
  </div>
  <div class="schedule-d-note">See instructions for how to figure the amounts to enter on the lines below.</div>

  <table class="schedule-d-table">
    <thead>
      <tr>
        <th class="col-line">Line</th>
        <th class="col-desc">Description</th>
        <th class="col-amount">(d) Proceeds<br>(sales price)</th>
        <th class="col-amount">(e) Cost<br>(or other basis)</th>
        <th class="col-amount">(g) Adjustments<br>to gain or loss</th>
        <th class="col-amount">(h) Gain or (loss)<br>Subtract (e) from (d) and combine with (g)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="col-line">8a</td>
        <td class="col-desc">Totals for all long-term transactions reported on Form 1099-B for which basis was reported to the IRS and for which you have no adjustments</td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'8a_d'|field_id }}" value="{{ fields|get_item:'8a_d'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'8a_e'|field_id }}" value="{{ fields|get_item:'8a_e'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'8a_g'|field_id }}" value="{{ fields|get_item:'8a_g'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'8a_h'|field_id }}" value="{{ fields|get_item:'8a_h'|field_value|default:'' }}" readonly></td>
      </tr>
      <tr>
        <td class="col-line">8b</td>
        <td class="col-desc">Totals for all transactions reported on Form(s) 8949 with Box D checked</td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'8b_d'|field_id }}" value="{{ fields|get_item:'8b_d'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'8b_e'|field_id }}" value="{{ fields|get_item:'8b_e'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'8b_g'|field_id }}" value="{{ fields|get_item:'8b_g'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'8b_h'|field_id }}" value="{{ fields|get_item:'8b_h'|field_value|default:'' }}" readonly></td>
      </tr>
      <tr>
        <td class="col-line">9</td>
        <td class="col-desc">Totals for all transactions reported on Form(s) 8949 with Box E checked</td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'9_d'|field_id }}" value="{{ fields|get_item:'9_d'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'9_e'|field_id }}" value="{{ fields|get_item:'9_e'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'9_g'|field_id }}" value="{{ fields|get_item:'9_g'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'9_h'|field_id }}" value="{{ fields|get_item:'9_h'|field_value|default:'' }}" readonly></td>
      </tr>
      <tr>
        <td class="col-line">10</td>
        <td class="col-desc">Totals for all transactions reported on Form(s) 8949 with Box F checked</td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'10_d'|field_id }}" value="{{ fields|get_item:'10_d'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'10_e'|field_id }}" value="{{ fields|get_item:'10_e'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'10_g'|field_id }}" value="{{ fields|get_item:'10_g'|field_value|default:'' }}"></td>
        <td><input type="text" class="irs-line-input" name="{{ fields|get_item:'10_h'|field_id }}" value="{{ fields|get_item:'10_h'|field_value|default:'' }}" readonly></td>
      </tr>
    </tbody>
  </table>

  <div class="schedule-d-single-lines">
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">11</span>
      <span class="schedule-d-line-text">Gain from Form 4797, Part I; long-term gain from Forms 2439 and 6252; and long-term gain or (loss) from Forms 4684, 6781, and 8824</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'11'|field_id }}" value="{{ fields|get_item:'11'|field_value|default:'' }}">
    </div>
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">12</span>
      <span class="schedule-d-line-text">Net long-term gain or (loss) from partnerships, S corporations, estates, and trusts from Schedule(s) K-1</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'12'|field_id }}" value="{{ fields|get_item:'12'|field_value|default:'' }}">
    </div>
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">13</span>
      <span class="schedule-d-line-text">Capital gain distributions. See the instructions</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'13'|field_id }}" value="{{ fields|get_item:'13'|field_value|default:'' }}">
    </div>
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">14</span>
      <span class="schedule-d-line-text">Long-term capital loss carryover. Enter the amount, if any, from line 13 of your Capital Loss Carryover Worksheet</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'14'|field_id }}" value="{{ fields|get_item:'14'|field_value|default:'' }}" style="color: red;">
    </div>
    <div class="schedule-d-form-line schedule-d-total-line">
      <span class="schedule-d-line-num">15</span>
      <span class="schedule-d-line-text"><strong>Net long-term capital gain or (loss).</strong> Combine lines 8a through 14 in column (h)</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'15'|field_id }}" value="{{ fields|get_item:'15'|field_value|default:'' }}" readonly>
    </div>
  </div>

  <div class="schedule-d-part-header">
    <strong>Part III &nbsp;&nbsp; Summary</strong>
  </div>

  <div class="schedule-d-single-lines">
    <div class="schedule-d-form-line schedule-d-total-line">
      <span class="schedule-d-line-num">16</span>
      <span class="schedule-d-line-text"><strong>Combine lines 7 and 15 and enter the result.</strong> If line 16 is a gain, enter the amount from line 16 on Form 1040, line 7. If you are filing Form 4952, go to line 17. Otherwise, skip lines 17-20 and go to line 21</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'16'|field_id }}" value="{{ fields|get_item:'16'|field_value|default:'' }}" readonly>
    </div>
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">17</span>
      <span class="schedule-d-line-text">Are lines 15 and 16 both gains?</span>
      <label><input type="checkbox" name="{{ fields|get_item:'17'|field_id }}" {% if fields|get_item:'17'|field_value %}checked{% endif %}> Yes</label>
    </div>
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">18</span>
      <span class="schedule-d-line-text">If you are required to complete the 28% Rate Gain Worksheet, enter the amount from line 7 of that worksheet</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'18'|field_id }}" value="{{ fields|get_item:'18'|field_value|default:'' }}">
    </div>
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">19</span>
      <span class="schedule-d-line-text">If you are required to complete the Unrecaptured Section 1250 Gain Worksheet, enter the amount from line 18 of that worksheet</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'19'|field_id }}" value="{{ fields|get_item:'19'|field_value|default:'' }}">
    </div>
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">20</span>
      <span class="schedule-d-line-text">Are lines 18 and 19 both zero or blank?</span>
      <label><input type="checkbox" name="{{ fields|get_item:'20'|field_id }}" {% if fields|get_item:'20'|field_value %}checked{% endif %}> Yes</label>
    </div>
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">21</span>
      <span class="schedule-d-line-text">If line 16 is a loss, enter here and on Form 1040, line 7, the <strong>smaller</strong> of: The loss on line 16; or ($3,000), or if married filing separately, ($1,500)</span>
      <input type="text" class="schedule-d-line-input irs-line-input" name="{{ fields|get_item:'21'|field_id }}" value="{{ fields|get_item:'21'|field_value|default:'' }}">
    </div>
    <div class="schedule-d-form-line">
      <span class="schedule-d-line-num">22</span>
      <span class="schedule-d-line-text">Do you have qualified dividends on Form 1040, line 3a?</span>
      <label><input type="checkbox" name="{{ fields|get_item:'22'|field_id }}" {% if fields|get_item:'22'|field_value %}checked{% endif %}> Yes</label>
    </div>
  </div>

  <div class="schedule-d-footer">
    <div class="schedule-d-footer-left">
      <strong>For Paperwork Reduction Act Notice, see your tax return instructions.</strong>
    </div>
    <div class="schedule-d-footer-center">
      Cat. No. 11338H
    </div>
    <div class="schedule-d-footer-right">
      <strong>Schedule D (Form 1040) {{ year }}</strong>
    </div>
  </div>
</div>

<button class="btn btn-outline-success mb-5 d-print-none" id="submitForm" type="submit" style="margin: 20px;">
  Save changes
</button>
</form>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitButton = document.getElementById('submitForm');

    if (form) {
      const isInIframe = window.self !== window.top;

      form.addEventListener('submit', function(event) {
        if (!isInIframe) {
          if (submitButton) {
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';
          }
          return true;
        }

        event.preventDefault();

        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = 'Saving...';
        }

        const formData = new FormData(event.target);
        const formProps = Object.fromEntries(formData);
        delete formProps['csrfmiddlewaretoken'];

        let parentOrigin;
        const currentOrigin = window.location.origin;

        try {
          parentOrigin = window.parent.location.origin;
        } catch (e) {
          if (currentOrigin === 'null') {
            parentOrigin = 'http://localhost:5100';
          } else if (currentOrigin.includes('localhost') || currentOrigin.includes('127.0.0.1')) {
            parentOrigin = 'http://localhost:5100';
          } else {
            parentOrigin = 'https://lowercoststaxes.com';
          }
        }

        try {
          const apiAction = event.target.dataset.apiAction || event.target.action;
          window.parent.postMessage({
            type: 'formSubmit',
            formData: formProps,
            url: apiAction
          }, parentOrigin);

          setTimeout(() => {
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.textContent = 'Save changes';
            }
          }, 1000);
        } catch (error) {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Save changes';
          }
        }
      });
    }
  });
</script>

{% endwith %}
{% endwith %}
{% endblock content %}
